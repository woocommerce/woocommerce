<?php

namespace Automattic\WooCommerce\Internal\Api\DesignTime\Scripts;

/**
 * Script to verify that the autogenerated API files aren't outdated before building the WooCommerce .zip package.
 */
class ApiDateVerifier {
	/**
	 * - If the src/Internal/Api/Autogenerated/api_generation_date.txt file doesn't exist, exits with code 1.
	 * - If any of the files in src/Api is newer than the date inside api_generation_date.txt, exits with code 2.
	 * - If the date inside docs/api/api_docs_generation_date.txt (in the root of the repo) is older than
	 *   the date inside api_generation_date.txt, exits with code 3.
	 * - Otherwise, exists with code 0.
	 */
	public static function run(): void {
		$autogenerated_api_dir = realpath( __DIR__ . '/../../Autogenerated' );

		$generation_date_file = $autogenerated_api_dir . '/api_generation_date.txt';
		if ( ! file_exists( $generation_date_file ) ) {
			exit( 1 );
		}

		// phpcs:ignore WordPress.WP.AlternativeFunctions
		$api_generation_date = file_get_contents( $generation_date_file );

		$api_dir = __DIR__ . '/../../../../Api';

		$files = self::file_search( $api_dir );
		foreach ( $files as $file ) {
			clearstatcache( false, $file );
			$file_modification_date = gmdate( 'Y-m-d H:i:s', filemtime( $file ) );
			if ( $file_modification_date > $api_generation_date ) {
				exit( 2 );
			}
		}

		$api_docs_generation_date_file = __DIR__ . '/../../../../../../../docs/api/api_docs_generation_date.txt';
		if ( ! file_exists( $api_docs_generation_date_file ) ) {
			exit( 3 );
		}

		// phpcs:ignore WordPress.WP.AlternativeFunctions
		$api_docs_generation_date = file_get_contents( $api_docs_generation_date_file );
		if ( $api_docs_generation_date < $api_generation_date ) {
			exit( 3 );
		}
	}

	/**
	 * Recursive file search.
	 *
	 * @param string $directory Directory to search files for.
	 * @return array Full file names of all the files in the directory, including subdirectories.
	 */
	private static function file_search( string $directory ): array {
		$directory = rtrim( $directory, '/' );
		$files     = glob( $directory . '/*.php' );
		$dirs      = glob( $directory . '/*', GLOB_ONLYDIR );
		foreach ( $dirs as $dir ) {
			if ( is_dir( $dir ) ) {
				$files = array_merge( $files, self::file_search( $dir, '*.php' ) );
			}
		}

		return array_map( 'realpath', $files );
	}
}

ApiDateVerifier::run();
