#!/bin/sh

PLUGIN_SLUG="woocommerce"
PROJECT_PATH=$(pwd)
BUILD_PATH="${PROJECT_PATH}/build"
DEST_PATH="$BUILD_PATH/$PLUGIN_SLUG"

if [ -z "${WOOCOMMERCE_BLOCKS_PHASE}" ]; then
    export WOOCOMMERCE_BLOCKS_PHASE=1
fi

echo "Verifying autogenerated API..."
php ./src/Internal/Api/DesignTime/Scripts/ApiDateVerifier.php
RESULT=$?
if [ $RESULT -eq 1 ]; then
	echo "*** The Api hasn't been properly generated. Please run 'pnpm run build:api' first."
	exit 1
fi
if [ $RESULT -eq 2 ]; then
	echo "*** The autogenerated API is outdated. Please run 'pnpm run build:api' first.";
	exit 2
fi

echo "Generating build directory..."
rm -rf "$BUILD_PATH"
mkdir -p "$DEST_PATH"

echo "Cleaning up assets..."
find "$PROJECT_PATH/assets/css/." ! -name '.gitkeep' -type f -exec rm -f {} + && find "$PROJECT_PATH/assets/client/." ! -name '.gitkeep' -type f -exec rm -f {} + && find "$PROJECT_PATH/assets/js/." ! -name '.gitkeep' -type f -exec rm -f {} +

echo "Installing PHP and JS dependencies..."
pnpm install

echo "Running JS Build..."
if [ -z "${NODE_ENV}" ]; then
	export NODE_ENV=production
fi
pnpm --filter='@woocommerce/plugin-woocommerce' build || exit "$?"
echo "Cleaning up PHP dependencies..."
composer install --no-dev || exit "$?"

if [ -z "${SKIP_MAKEPOT}" ]; then
	echo "Run makepot..."
	pnpm --filter=@woocommerce/plugin-woocommerce makepot || exit "$?"
fi

echo "Syncing files..."
rsync -rc --exclude-from="$PROJECT_PATH/.distignore" "$PROJECT_PATH/" "$DEST_PATH/" --delete --delete-excluded

echo "Generating zip file..."
cd "$BUILD_PATH" || exit
zip -q -r "${PLUGIN_SLUG}.zip" "$PLUGIN_SLUG/"

cd "$PROJECT_PATH" || exit
mv "$BUILD_PATH/${PLUGIN_SLUG}.zip" "$PROJECT_PATH"
echo "${PLUGIN_SLUG}.zip file generated!"

echo "Build done!"
